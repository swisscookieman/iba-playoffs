<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBA Playoff Predicitor</title>
    <style>
        :root {
            --bg-color: #1a1b21;
            --card-bg: #25262e;
            --accent: #4a90e2;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --border: #383a42;
            --success: #4caf50;
            --view-accent: #e2b74a; /* Gold color for the view tab */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        /* Layout & Tabs */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            padding: 15px 25px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom: 3px solid var(--accent);
            margin-bottom: -2px;
        }
        
        /* Special coloring for View Tab */
        .tab-btn[onclick*="view"].active {
            color: var(--view-accent);
            border-bottom: 3px solid var(--view-accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Bracket Grid */
        .round-section {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        h2 { border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-top: 0; color: var(--accent); }
        h3 { color: var(--text-muted); font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; }

        .matchup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .matchup-card {
            background: #2f313a;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }
        
        /* View Mode Card Styling */
        .view-card {
            border-left: 3px solid var(--view-accent);
            background: #222;
        }
        .view-winner {
            color: var(--success);
            font-weight: bold;
            font-size: 1.1em;
        }
        .view-loser {
            color: var(--text-muted);
            text-decoration: line-through;
            font-size: 0.9em;
        }
        .view-score {
            float: right;
            color: var(--view-accent);
            font-family: monospace;
            font-weight: bold;
        }

        .matchup-title {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: block;
        }

        /* Form Elements */
        select, input {
            background-color: #1a1b21;
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            margin-bottom: 8px;
        }

        label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 4px;
            display: block;
        }

        button.action-btn {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
        }

        button.action-btn.view-btn {
            background-color: var(--view-accent);
            color: #1a1b21;
            font-weight: bold;
        }

        button.action-btn:hover {
            filter: brightness(1.1);
        }

        /* Results Area */
        .result-box {
            background: #000;
            padding: 15px;
            font-family: monospace;
            word-break: break-all;
            border: 1px solid var(--border);
            margin-top: 10px;
            display: none;
            color: var(--success);
        }

        .score-display {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: var(--success);
        }

        .breakdown {
            font-size: 0.9rem;
            line-height: 1.6;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('pick')">IBA Bracket Maker</button>
        <button class="tab-btn" onclick="switchTab('view')">View Bracket</button>
        <button class="tab-btn" onclick="switchTab('score')">Calculate Score</button>
    </div>

    <div id="pick" class="tab-content active">
        <div class="round-section">
            <h2>Round 1 (Play-in Round)</h2>
            <h3>Best of 5</h3>
            <div class="matchup-grid" id="r1-container">
                </div>
        </div>

        <div class="round-section" id="r2-section" style="opacity: 0.5; pointer-events: none;">
            <h2>Round 2 (Conference Quarterfinals)</h2>
            <h3>Best of 7 (Top Seeds Enter)</h3>
            <div class="matchup-grid" id="r2-container"></div>
        </div>

        <div class="round-section" id="r3-section" style="opacity: 0.5; pointer-events: none;">
            <h2>Round 3 (Conference Semifinals)</h2>
            <h3>Best of 7</h3>
            <div class="matchup-grid" id="r3-container"></div>
        </div>

        <div class="round-section" id="r4-section" style="opacity: 0.5; pointer-events: none;">
            <h2>Round 4 (Conference Finals)</h2>
            <h3>Best of 7</h3>
            <div class="matchup-grid" id="r4-container"></div>
        </div>

        <div class="round-section" id="r5-section" style="opacity: 0.5; pointer-events: none;">
            <h2>Round 5 (League Finals)</h2>
            <h3>Best of 7</h3>
            <div class="matchup-grid" id="r5-container"></div>
        </div>

        <button class="action-btn" onclick="generateCode()">Export Bracket Code</button>
        <div id="export-result" class="result-box"></div>
    </div>

    <div id="view" class="tab-content">
        <div class="round-section">
            <h2>Import Bracket</h2>
            <label>Paste Bracket Code</label>
            <input type="text" id="view-input-code" placeholder="Paste a code here to view the full bracket tree...">
            <button class="action-btn view-btn" onclick="visualizeCode()">Load Bracket</button>
        </div>

        <div id="view-display-area" style="display:none;">
            <div class="round-section">
                <h2>Round 1 Results</h2>
                <div class="matchup-grid" id="v-r1"></div>
            </div>
            <div class="round-section">
                <h2>Round 2 Results</h2>
                <div class="matchup-grid" id="v-r2"></div>
            </div>
            <div class="round-section">
                <h2>Round 3 Results</h2>
                <div class="matchup-grid" id="v-r3"></div>
            </div>
            <div class="round-section">
                <h2>Round 4 Results</h2>
                <div class="matchup-grid" id="v-r4"></div>
            </div>
            <div class="round-section" style="border-color: var(--view-accent);">
                <h2 style="color: var(--view-accent);">Championship Result</h2>
                <div class="matchup-grid" id="v-r5"></div>
            </div>
        </div>
    </div>

    <div id="score" class="tab-content">
        <div class="round-section">
            <h2>Score Calculator</h2>
            <label>Perfect Bracket Code (Official Results)</label>
            <input type="text" id="perfect-code" placeholder="Paste the code for the correct outcomes...">
            
            <label>Player Bracket Code</label>
            <input type="text" id="player-code" placeholder="Paste the player's code...">

            <button class="action-btn" onclick="calculateScore()">Calculate</button>
        </div>

        <div id="score-output" class="round-section" style="display:none;">
            <div class="score-display">Total Score: <span id="final-score">0</span></div>
            <div class="breakdown" id="score-breakdown"></div>
        </div>
    </div>
</div>

<script>
    // --- DATA SETUP ---
    const conferences = {
        west: {
            seeds: {
                1: "Los Angeles", 2: "Geneva", 3: "Madrid", 4: "London",
                5: "New York", 6: "Berlin", 7: "Hawaii", 8: "Vancouver",
                9: "Mexico City", 10: "Lima", 11: "Belgrade", 12: "Buenos Aires"
            }
        },
        east: {
            seeds: {
                1: "Wellington", 2: "Manila", 3: "Beijing", 4: "Istanbul",
                5: "Jakarta", 6: "Singapore", 7: "Kaunas", 8: "Cairo",
                9: "Moscow", 10: "Johannesburg", 11: "Riyadh", 12: "Seoul"
            }
        }
    };

    const scoresBo5 = ["3-0", "3-1", "3-2"];
    const scoresBo7 = ["4-0", "4-1", "4-2", "4-3"];
    let picks = {};

    // Match Definitions
    const round1Matches = [
        { id: "w_r1_1", conf: "west", high: 8, low: 9, next: "w_r2_1", nextPos: "low" },
        { id: "w_r1_2", conf: "west", high: 5, low: 12, next: "w_r2_2", nextPos: "low" },
        { id: "w_r1_3", conf: "west", high: 6, low: 11, next: "w_r2_3", nextPos: "low" },
        { id: "w_r1_4", conf: "west", high: 7, low: 10, next: "w_r2_4", nextPos: "low" },
        { id: "e_r1_1", conf: "east", high: 8, low: 9, next: "e_r2_1", nextPos: "low" },
        { id: "e_r1_2", conf: "east", high: 5, low: 12, next: "e_r2_2", nextPos: "low" },
        { id: "e_r1_3", conf: "east", high: 6, low: 11, next: "e_r2_3", nextPos: "low" },
        { id: "e_r1_4", conf: "east", high: 7, low: 10, next: "e_r2_4", nextPos: "low" }
    ];

    const round2Matches = [
        { id: "w_r2_1", conf: "west", high: 1, lowSrc: "w_r1_1", next: "w_r3_1", nextPos: "high" },
        { id: "w_r2_2", conf: "west", high: 4, lowSrc: "w_r1_2", next: "w_r3_1", nextPos: "low" },
        { id: "w_r2_3", conf: "west", high: 3, lowSrc: "w_r1_3", next: "w_r3_2", nextPos: "high" },
        { id: "w_r2_4", conf: "west", high: 2, lowSrc: "w_r1_4", next: "w_r3_2", nextPos: "low" },
        { id: "e_r2_1", conf: "east", high: 1, lowSrc: "e_r1_1", next: "e_r3_1", nextPos: "high" },
        { id: "e_r2_2", conf: "east", high: 4, lowSrc: "e_r1_2", next: "e_r3_1", nextPos: "low" },
        { id: "e_r2_3", conf: "east", high: 3, lowSrc: "e_r1_3", next: "e_r3_2", nextPos: "high" },
        { id: "e_r2_4", conf: "east", high: 2, lowSrc: "e_r1_4", next: "e_r3_2", nextPos: "low" },
    ];

    const round3Matches = [
        { id: "w_r3_1", conf: "west", highSrc: "w_r2_1", lowSrc: "w_r2_2", next: "w_r4_1", nextPos: "high" },
        { id: "w_r3_2", conf: "west", highSrc: "w_r2_3", lowSrc: "w_r2_4", next: "w_r4_1", nextPos: "low" },
        { id: "e_r3_1", conf: "east", highSrc: "e_r2_1", lowSrc: "e_r2_2", next: "e_r4_1", nextPos: "high" },
        { id: "e_r3_2", conf: "east", highSrc: "e_r2_3", lowSrc: "e_r2_4", next: "e_r4_1", nextPos: "low" },
    ];

    const round4Matches = [
        { id: "w_r4_1", conf: "west", highSrc: "w_r3_1", lowSrc: "w_r3_2", next: "f_r5_1", nextPos: "high" },
        { id: "e_r4_1", conf: "east", highSrc: "e_r3_1", lowSrc: "e_r3_2", next: "f_r5_1", nextPos: "low" },
    ];

    const round5Matches = [
        { id: "f_r5_1", conf: "final", highSrc: "w_r4_1", lowSrc: "e_r4_1", next: null }
    ];

    function init() {
        renderRound1();
    }

    function getName(conf, seed) {
        if(conf === 'final') return seed;
        return conferences[conf].seeds[seed];
    }

    // --- PICKER RENDERERS ---

    function createMatchupHTML(id, team1, team2, bestOf, nextRoundId) {
        const scores = bestOf === 5 ? scoresBo5 : scoresBo7;
        const options = scores.map(s => `<option value="${s}">${s}</option>`).join('');
        
        return `
        <div class="matchup-card" id="card-${id}">
            <span class="matchup-title">Series ID: ${id}</span>
            <label>Winner</label>
            <select onchange="updateBracket('${id}', '${nextRoundId}', this.value)" id="pick-${id}">
                <option value="">-- Select Winner --</option>
                <option value="${team1.seed}|${team1.conf}">${team1.seed}. ${team1.name}</option>
                <option value="${team2.seed}|${team2.conf}">${team2.seed}. ${team2.name}</option>
            </select>
            <label>Series Score</label>
            <select id="score-${id}">
                ${options}
            </select>
        </div>`;
    }

    function renderRound1() {
        const container = document.getElementById('r1-container');
        let html = '';
        round1Matches.forEach(m => {
            const t1 = { seed: m.high, name: getName(m.conf, m.high), conf: m.conf };
            const t2 = { seed: m.low, name: getName(m.conf, m.low), conf: m.conf };
            html += createMatchupHTML(m.id, t1, t2, 5, 'r2');
        });
        container.innerHTML = html;
    }

    // --- LOGIC UPDATES ---

    function updateBracket(matchId, triggerNextLevel) {
        const winnerVal = document.getElementById(`pick-${matchId}`).value;
        const scoreVal = document.getElementById(`score-${matchId}`).value;
        
        if(!winnerVal) return;

        const [seed, conf] = winnerVal.split('|');
        picks[matchId] = { seed: parseInt(seed), conf: conf, score: scoreVal };

        if(triggerNextLevel === 'r2') checkRoundComplete(round1Matches, renderRound2, 'r2-section');
        if(triggerNextLevel === 'r3') checkRoundComplete(round2Matches, renderRound3, 'r3-section');
        if(triggerNextLevel === 'r4') checkRoundComplete(round3Matches, renderRound4, 'r4-section');
        if(triggerNextLevel === 'r5') checkRoundComplete(round4Matches, renderRound5, 'r5-section');
    }

    function checkRoundComplete(matches, renderFn, sectionId) {
        const allPicked = matches.every(m => picks[m.id]);
        if(allPicked) {
            renderFn();
            const sec = document.getElementById(sectionId);
            sec.style.opacity = "1";
            sec.style.pointerEvents = "all";
        }
    }

    function renderRound2() {
        const container = document.getElementById('r2-container');
        let html = '';
        round2Matches.forEach(m => {
            const t1 = { seed: m.high, name: getName(m.conf, m.high), conf: m.conf };
            const prevPick = picks[m.lowSrc];
            const t2 = { seed: prevPick.seed, name: getName(prevPick.conf, prevPick.seed), conf: prevPick.conf };
            html += createMatchupHTML(m.id, t1, t2, 7, 'r3');
        });
        container.innerHTML = html;
    }

    function renderRound3() {
        const container = document.getElementById('r3-container');
        let html = '';
        round3Matches.forEach(m => {
            const p1 = picks[m.highSrc];
            const t1 = { seed: p1.seed, name: getName(p1.conf, p1.seed), conf: p1.conf };
            const p2 = picks[m.lowSrc];
            const t2 = { seed: p2.seed, name: getName(p2.conf, p2.seed), conf: p2.conf };
            html += createMatchupHTML(m.id, t1, t2, 7, 'r4');
        });
        container.innerHTML = html;
    }

    function renderRound4() {
        const container = document.getElementById('r4-container');
        let html = '';
        round4Matches.forEach(m => {
            const p1 = picks[m.highSrc];
            const t1 = { seed: p1.seed, name: getName(p1.conf, p1.seed), conf: p1.conf };
            const p2 = picks[m.lowSrc];
            const t2 = { seed: p2.seed, name: getName(p2.conf, p2.seed), conf: p2.conf };
            html += createMatchupHTML(m.id, t1, t2, 7, 'r5');
        });
        container.innerHTML = html;
    }

    function renderRound5() {
        const container = document.getElementById('r5-container');
        let html = '';
        round5Matches.forEach(m => {
            const p1 = picks[m.highSrc]; 
            const t1 = { seed: p1.seed, name: getName(p1.conf, p1.seed), conf: p1.conf };
            const p2 = picks[m.lowSrc]; 
            const t2 = { seed: p2.seed, name: getName(p2.conf, p2.seed), conf: p2.conf };
            html += createMatchupHTML(m.id, t1, t2, 7, 'end');
        });
        container.innerHTML = html;
    }

    function generateCode() {
        if(!picks['f_r5_1']) {
            alert("Please complete the entire bracket first.");
            return;
        }
        // Force update last pick
        const finalSelect = document.getElementById('pick-f_r5_1');
        const finalScore = document.getElementById('score-f_r5_1');
        const [seed, conf] = finalSelect.value.split('|');
        picks['f_r5_1'] = { seed: parseInt(seed), conf: conf, score: finalScore.value };

        const json = JSON.stringify(picks);
        const code = btoa(json);
        
        const resBox = document.getElementById('export-result');
        resBox.style.display = 'block';
        resBox.innerText = code;
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        const btns = document.getElementsByClassName('tab-btn');
        for(let b of btns) {
            if(b.getAttribute('onclick').includes(tab)) b.classList.add('active');
        }
    }

    // --- VIEW / VISUALIZER LOGIC (NEW) ---

    function createViewCard(t1, t2, winnerData) {
        // Determine who is winner/loser for styling
        const t1IsWinner = (t1.seed === winnerData.seed && t1.conf === winnerData.conf);
        
        const t1Class = t1IsWinner ? 'view-winner' : 'view-loser';
        const t2Class = !t1IsWinner ? 'view-winner' : 'view-loser';

        return `
        <div class="matchup-card view-card">
            <span class="view-score">${winnerData.score}</span>
            <div class="${t1Class}">${t1.seed}. ${t1.name}</div>
            <div class="${t2Class}">${t2.seed}. ${t2.name}</div>
        </div>`;
    }

    function visualizeCode() {
        const inputCode = document.getElementById('view-input-code').value.trim();
        if(!inputCode) { alert("Please enter a code"); return; }

        try {
            const data = JSON.parse(atob(inputCode));
            document.getElementById('view-display-area').style.display = 'block';

            // R1
            let html = '';
            round1Matches.forEach(m => {
                const t1 = { seed: m.high, name: getName(m.conf, m.high), conf: m.conf };
                const t2 = { seed: m.low, name: getName(m.conf, m.low), conf: m.conf };
                if(data[m.id]) html += createViewCard(t1, t2, data[m.id]);
            });
            document.getElementById('v-r1').innerHTML = html;

            // R2
            html = '';
            round2Matches.forEach(m => {
                // Determine teams based on stored picks
                const t1 = { seed: m.high, name: getName(m.conf, m.high), conf: m.conf }; // Waiting seed
                const prev = data[m.lowSrc];
                if(prev && data[m.id]) {
                    const t2 = { seed: prev.seed, name: getName(prev.conf, prev.seed), conf: prev.conf };
                    html += createViewCard(t1, t2, data[m.id]);
                }
            });
            document.getElementById('v-r2').innerHTML = html;

            // R3
            html = '';
            round3Matches.forEach(m => {
                const p1 = data[m.highSrc];
                const p2 = data[m.lowSrc];
                if(p1 && p2 && data[m.id]) {
                    const t1 = { seed: p1.seed, name: getName(p1.conf, p1.seed), conf: p1.conf };
                    const t2 = { seed: p2.seed, name: getName(p2.conf, p2.seed), conf: p2.conf };
                    html += createViewCard(t1, t2, data[m.id]);
                }
            });
            document.getElementById('v-r3').innerHTML = html;

            // R4
            html = '';
            round4Matches.forEach(m => {
                const p1 = data[m.highSrc];
                const p2 = data[m.lowSrc];
                if(p1 && p2 && data[m.id]) {
                    const t1 = { seed: p1.seed, name: getName(p1.conf, p1.seed), conf: p1.conf };
                    const t2 = { seed: p2.seed, name: getName(p2.conf, p2.seed), conf: p2.conf };
                    html += createViewCard(t1, t2, data[m.id]);
                }
            });
            document.getElementById('v-r4').innerHTML = html;

            // R5
            html = '';
            round5Matches.forEach(m => {
                const p1 = data[m.highSrc];
                const p2 = data[m.lowSrc];
                if(p1 && p2 && data[m.id]) {
                    const t1 = { seed: p1.seed, name: getName(p1.conf, p1.seed), conf: p1.conf };
                    const t2 = { seed: p2.seed, name: getName(p2.conf, p2.seed), conf: p2.conf };
                    html += createViewCard(t1, t2, data[m.id]);
                }
            });
            document.getElementById('v-r5').innerHTML = html;

        } catch (e) {
            alert("Invalid Code");
            console.error(e);
        }
    }

    // --- SCORING ENGINE ---

    function calculateScore() {
        const pCode = document.getElementById('player-code').value.trim();
        const rCode = document.getElementById('perfect-code').value.trim();

        if(!pCode || !rCode) {
            alert("Please enter both codes.");
            return;
        }

        try {
            const playerPicks = JSON.parse(atob(pCode));
            const realPicks = JSON.parse(atob(rCode));
            
            let totalScore = 0;
            let log = "<ul>";

            const checkMatch = (id, roundName, roundVal) => {
                if(!playerPicks[id] || !realPicks[id]) return;

                const p = playerPicks[id];
                const r = realPicks[id];
                const pTeam = `${p.seed} ${p.conf}`;
                const rTeam = `${r.seed} ${r.conf}`;

                if(pTeam === rTeam) {
                    let pts = 1; 
                    let note = `Correct Winner (${getName(p.conf, p.seed)})`;
                    
                    if(id.includes('r3')) { pts += 2; note += " + Conference Finalist Bonus (2pts)"; }
                    if(id.includes('r4')) { pts += 3; note += " + Finalist Bonus (3pts)"; }
                    if(id.includes('r5')) { pts = 4; note = "CHAMPION PREDICTED (4pts)"; }

                    if(p.score === r.score) {
                        pts += 3;
                        note += " + Exact Score Bonus (3pts)";
                    }

                    totalScore += pts;
                    log += `<li><strong>${roundName}:</strong> ${note} (+${pts})</li>`;
                }
            };

            round1Matches.forEach(m => checkMatch(m.id, "Round 1", 1));
            round2Matches.forEach(m => checkMatch(m.id, "Round 2", 1));
            round3Matches.forEach(m => checkMatch(m.id, "Round 3", 1));
            round4Matches.forEach(m => checkMatch(m.id, "Conf Finals", 1));
            checkMatch("f_r5_1", "League Finals", 1);

            log += "</ul>";
            
            document.getElementById('final-score').innerText = totalScore;
            document.getElementById('score-breakdown').innerHTML = log;
            document.getElementById('score-output').style.display = 'block';

        } catch (e) {
            alert("Invalid Code entered. Please check your inputs.");
            console.error(e);
        }
    }

    init();

</script>
</body>
</html>
